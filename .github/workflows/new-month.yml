name: Create Monthly Markdown

permissions:
  contents: write
  
on:
  workflow_dispatch:
    inputs:
      year:
        description: "연도 (예: 2026)"
        required: true
      month:
        description: "월 (1~12)"
        required: true
      p1:
        description: "1주 계획"
        required: false
        default: ""
      p2:
        description: "2주 계획"
        required: false
        default: ""
      p3:
        description: "3주 계획"
        required: false
        default: ""
      p4:
        description: "4주 계획"
        required: false
        default: ""
      p5:
        description: "5주 계획"
        required: false
        default: ""

jobs:
  create-month:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

- name: Set date vars
  run: |
    YEAR="${{ github.event.inputs.year }}"
    MONTH_RAW="${{ github.event.inputs.month }}"
    MONTH=$(printf "%02d" "$MONTH_RAW")

    echo "YEAR=$YEAR" >> $GITHUB_ENV
    echo "MONTH=$MONTH" >> $GITHUB_ENV
    echo "FILENAME=${YEAR}-${MONTH}.md" >> $GITHUB_ENV

    echo "P1=${{ github.event.inputs.p1 }}" >> $GITHUB_ENV
    echo "P2=${{ github.event.inputs.p2 }}" >> $GITHUB_ENV
    echo "P3=${{ github.event.inputs.p3 }}" >> $GITHUB_ENV
    echo "P4=${{ github.event.inputs.p4 }}" >> $GITHUB_ENV
    echo "P5=${{ github.event.inputs.p5 }}" >> $GITHUB_ENV

    BASE_DATE="${YEAR}-${MONTH}-01"

    DOW=$(date -d "$BASE_DATE" +%u)
    if [ "$DOW" -eq 1 ]; then
      FIRST_MON="$BASE_DATE"
    else
      FIRST_MON=$(date -d "$BASE_DATE +$((8 - DOW)) days" +%Y-%m-%d)
    fi

    w() {
      START=$(date -d "$FIRST_MON +$((($1 - 1) * 7)) days" +%m/%d)
      END=$(date -d "$FIRST_MON +$((($1 - 1) * 7 + 4)) days" +%m/%d)
      echo "${START}(월) ~ ${END}(금)"
    }

    echo "W1=$(w 1)" >> $GITHUB_ENV
    echo "W2=$(w 2)" >> $GITHUB_ENV
    echo "W3=$(w 3)" >> $GITHUB_ENV
    echo "W4=$(w 4)" >> $GITHUB_ENV
    echo "W5=$(w 5)" >> $GITHUB_ENV
          
      - name: Check if month file already exists
        run: |
          if [ -f "${FILENAME}" ]; then
            echo "${FILENAME} already exists. Skip creating."
            exit 0
          fi
          
      - name: Create month file from template
        run: |
          sed \
            -e "s|{{YEAR}}|${YEAR}|g" \
            -e "s|{{MONTH}}|${MONTH}|g" \
            -e "s|{{W1}}|${W1}|g" \
            -e "s|{{W2}}|${W2}|g" \
            -e "s|{{W3}}|${W3}|g" \
            -e "s|{{W4}}|${W4}|g" \
            -e "s|{{W5}}|${W5}|g" \
            -e "s|{{P1}}|${P1}|g" \
            -e "s|{{P2}}|${P2}|g" \
            -e "s|{{P3}}|${P3}|g" \
            -e "s|{{P4}}|${P4}|g" \
            -e "s|{{P5}}|${P5}|g" \
            templates/month.md > ${FILENAME}

      - name: Populate weekly plans from monthly table
        run: |
          python << 'EOF'
          import re

          filename = "${{ env.FILENAME }}"

          with open(filename, "r", encoding="utf-8") as f:
              text = f.read()

          # 월간 계획 표에서 계획(P1~P5) 추출
          plans = {}
          for i in range(1, 6):
              m = re.search(rf"\|\s*{i}주\s*\|.*?\|\s*(.*?)\s*\|", text)
              plans[i] = m.group(1) if m else ""

          # 각 주 섹션에 삽입
          for i in range(1, 6):
              pattern = rf"(<!-- AUTO_PLAN_{i}_START -->)(.*?)(<!-- AUTO_PLAN_{i}_END -->)"
              repl = rf"\\1\n{plans[i]}\n\\3"
              text = re.sub(pattern, repl, text, flags=re.S)

          with open(filename, "w", encoding="utf-8") as f:
              f.write(text)
          EOF

      - name: Commit file (if changed)
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add ${FILENAME}

          if git diff --cached --quiet; then
            echo "No changes to commit. Skip."
            exit 0
          fi

          git commit -m "Add ${FILENAME}"
          git push
